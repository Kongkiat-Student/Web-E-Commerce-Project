<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - FE_Shop</title>

    
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="checkout.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <nav>
        <div class="nav-container">
            <a href="index.html">
                <img src="./imgs/bird.png" class="logonav">
            </a>

            <div class="nav-profile">
                <p class="nav-profile-name">SHOP</p>
                <div onclick="openCart()" style="cursor: pointer;" class="nav-profile-cart">
                    <i class="fas fa-cart-shopping"></i>
                    <div id="cartcount" class="cartcount" style="display: none;">
                        0
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Checkout</h2>

        <h3>Order Summary</h3>
        <div id="order-summary">
            <!-- รายละเอียดของสินค้าที่เลือกในตะกร้าจะแสดงในที่นี้ -->
        </div>
        <br>

        <h3>Shipping Information</h3>
        <label for="full-name">Full Name:</label>
        <input id="full-name" type="text" class="input" placeholder="Enter your full name" required>

        <label for="shipping-address">Address:</label>
        <input id="shipping-address" type="text" class="input" placeholder="Enter shipping address" required>

        <label for="city">City:</label>
        <input id="city" type="text" class="input" placeholder="Enter city" required>

        <label for="postal-code">Postal Code:</label>
        <input id="postal-code" type="text" class="input" placeholder="Enter postal code" required>

        <label for="country">Country:</label>
        <select id="country" class="input" required>
            <option value="thailand">Thailand</option>
            <option value="usa">United States</option>
            <option value="uk">United Kingdom</option>
            <option value="canada">Canada</option>
            <option value="australia">Australia</option>
        </select>

        <label for="phone-number">Phone Number:</label>
        <input id="phone-number" type="tel" class="input" placeholder="Enter your phone number" required>

        <h3>Payment Method</h3>
        <select id="payment-method" class="input" required>
            <option value="credit-card">Credit Card</option>
            <option value="paypal">PayPal</option>
            <option value="bank-transfer">Bank Transfer</option>
            <option value="cash-on-delivery">Cash on Delivery</option>
        </select>
        <br><br>

        <div class="btn-control">
            <button onclick="goBackToCart()" class="btn">Back to Cart</button>
            <button onclick="confirmOrder()" class="btn btn-buy">Confirm Order</button>
        </div>
    </div>

    <script>
        // ฟังก์ชันกลับไปที่หน้าตะกร้าสินค้า
        function goBackToCart() {
            window.location.href = 'index.html';  // เปลี่ยนลิงก์ไปยังหน้าตะกร้าสินค้า
        }

        function confirmOrder() {
    // ดึงข้อมูลการจัดส่ง
    let fullName = document.getElementById('full-name').value;
    let address = document.getElementById('shipping-address').value;
    let city = document.getElementById('city').value;
    let postalCode = document.getElementById('postal-code').value;
    let country = document.getElementById('country').value;
    let phoneNumber = document.getElementById('phone-number').value;
    let paymentMethod = document.getElementById('payment-method').value;

    // ตรวจสอบว่าฟิลด์ข้อมูลการจัดส่งมีการกรอกข้อมูลครบถ้วนหรือไม่
    if (fullName === '' || address === '' || city === '' || postalCode === '' || country === '' || phoneNumber === '') {
        Swal.fire('กรุณากรอกข้อมูลการจัดส่งทั้งหมด', '', 'warning');
        return;
    }

    // ดึงข้อมูลตะกร้าสินค้า
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    // ดึงข้อมูลผลิตภัณฑ์ล่าสุดจากฐานข้อมูล
    $.ajax({
        method: 'get',
        url: './api/getallproduct.php',
        success: function(response) {
            if(response.RespCode == 200) {
                const latestProducts = response.Result;

                // ตรวจสอบราคาของสินค้าที่อยู่ในตะกร้า
                let priceMismatch = false;
                let priceDetails = '';

                cart.forEach(item => {
                    const latestProduct = latestProducts.find(product => product.id == item.id);
                    if (latestProduct && latestProduct.price !== item.price) {
                        priceMismatch = true;
                        priceDetails += `${item.name}: ราคาตะกร้า: ${numberWithCommas(item.price)} THB, ราคาล่าสุด: ${numberWithCommas(latestProduct.price)} THB<br>`;
                    }
                });

                if (priceMismatch) {
                    Swal.fire({
                        title: 'ราคาสินค้าเปลี่ยนแปลง',
                        html: `สินค้าที่มีการเปลี่ยนแปลงราคา:<br>${priceDetails}<br>คุณต้องการดำเนินการต่อด้วยราคาปัจจุบันหรือไม่?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ใช่',
                        cancelButtonText: 'ไม่ใช่'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            placeOrder(fullName, address, city, postalCode, country, phoneNumber, paymentMethod);
                        }
                    });
                } else {
                    placeOrder(fullName, address, city, postalCode, country, phoneNumber, paymentMethod); // ไม่มีการเปลี่ยนแปลงราคา ดำเนินการสั่งซื้อ
                }
            }
        },
        error: function(err) {
            console.log(err);
        }
    });
}

function placeOrder(fullName, address, city, postalCode, country, phoneNumber, paymentMethod) {
    Swal.fire({
        title: 'ยืนยันคำสั่งซื้อของคุณ',
        text: `จัดส่งไปที่: ${fullName}\nที่อยู่: ${address}, ${city}, ${postalCode}, ${country}\nโทรศัพท์: ${phoneNumber}\nวิธีการชำระเงิน: ${paymentMethod}`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire('ยืนยันคำสั่งซื้อแล้ว!', 'คำสั่งซื้อของคุณถูกวางเรียบร้อยแล้ว', 'success');
            localStorage.removeItem('cart'); // เคลียร์ตะกร้า
            window.location.href = 'index.html'; // เปลี่ยนหน้าไปยังหน้าหลัก
        }
    });
}ผ


        // ฟังก์ชันแสดงสรุปรายการสั่งซื้อจากข้อมูลใน localStorage
        function loadOrderSummary() {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            let summary = '<ul>';
            let total = 0;

            cart.forEach(item => {
                summary += `<li>${item.name} - ${item.quantity} x ${item.price} THB</li>`;
                total += item.quantity * item.price;
            });

            summary += `</ul><p>Total: ${total} THB</p>`;
            document.getElementById('order-summary').innerHTML = summary;
        }

        // เรียกฟังก์ชันเมื่อโหลดหน้าเสร็จ
        $(document).ready(function() {
            loadOrderSummary();
        });
        
        function confirmOrder() {
    // ดึงข้อมูลผลิตภัณฑ์ล่าสุด
    $.ajax({
        method: 'get',
        url: './api/getallproduct.php',
        success: function(response) {
            if(response.RespCode == 200) {
                const latestProducts = response.Result;

                // ตรวจสอบราคาของสินค้าที่อยู่ในตะกร้า
                let priceMismatch = false;
                let priceDetails = '';

                cart.forEach(item => {
                    const latestProduct = latestProducts.find(product => product.id === item.id);
                    if (latestProduct && latestProduct.price !== item.price) {
                        priceMismatch = true;
                        priceDetails += `${item.name}: ราคาตะกร้า: ${numberWithCommas(item.price)} THB, ราคาล่าสุด: ${numberWithCommas(latestProduct.price)} THB<br>`;
                    }
                });

                if (priceMismatch) {
                    Swal.fire({
                        title: 'ราคาตรงกันหรือไม่',
                        html: `สินค้าที่มีการเปลี่ยนแปลงราคา:<br>${priceDetails}<br>คุณต้องการดำเนินการต่อด้วยราคาปัจจุบันหรือไม่?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'ใช่',
                        cancelButtonText: 'ไม่ใช่'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            placeOrder(); // ดำเนินการสั่งซื้อ
                        }
                    });
                } else {
                    placeOrder(); // ไม่มีการเปลี่ยนแปลงราคา ดำเนินการสั่งซื้อ
                }
            }
        },
        error: function(err) {
            console.log(err);
        }
    });
}

function placeOrder() {
    // ลอจิกการยืนยันคำสั่งซื้อเดิม
    let fullName = document.getElementById('full-name').value;
    let address = document.getElementById('shipping-address').value;
    let city = document.getElementById('city').value;
    let postalCode = document.getElementById('postal-code').value;
    let country = document.getElementById('country').value;
    let phoneNumber = document.getElementById('phone-number').value;
    let paymentMethod = document.getElementById('payment-method').value;

    if (fullName === '' || address === '' || city === '' || postalCode === '' || country === '' || phoneNumber === '') {
        alert('กรุณากรอกข้อมูลการจัดส่งทั้งหมด');
        return;
    }

    Swal.fire({
        title: 'ยืนยันคำสั่งซื้อของคุณ',
        text: `จัดส่งไปที่: ${fullName}\nที่อยู่: ${address}, ${city}, ${postalCode}, ${country}\nโทรศัพท์: ${phoneNumber}\nวิธีการชำระเงิน: ${paymentMethod}`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire('ยืนยันคำสั่งซื้อแล้ว!', 'คำสั่งซื้อของคุณถูกวางเรียบร้อยแล้ว', 'success');
            localStorage.removeItem('cart');
            window.location.href = 'index.html';
        }
    });
}
    </script>
    

</body>
</html>
